!function(){"use strict";window.nx={},window.nxt={},window.nx.Utils={interpolateString:function(a,b){var c=a.match(/[^{\}]+(?=\})/g);return c&&c.forEach(function(c){a=a.replace("{"+c+"}",b[c])}),a},mixin:function(a,b){var c=Object.getOwnPropertyNames(b);c.forEach(function(c){var d=Object.getOwnPropertyDescriptor(b,c);Object.defineProperty(a,c,d)})}},nx.AsyncStatus={LOADING:1,DONE:2,ERROR:3},nx.AjaxModel=function(a){a=a||{},this.data=new nx.Cell,this.error=new nx.Cell,this.status=new nx.Cell,"undefined"!=typeof a.data&&(this.data.value=a.data)},nx.AjaxModel.prototype.request=function(a){var b=this,c=nx.Utils.interpolateString(a.url,this.data.value);this.xhr=new XMLHttpRequest,this.xhr.open(a.method,c,!0),this.xhr.responseType=window.chrome?"text":"json",this.xhr.onload=function(){var c,d;"json"===this.responseType?d=this.response:this.responseText&&(d=JSON.parse(this.responseText)),200===this.status||201===this.status||204===this.status?(c=a.success,b.data.value=d,b.status.value=nx.AsyncStatus.DONE):(c=a.error,b.error.value=d,b.status.value=nx.AsyncStatus.ERROR),"function"==typeof c&&c(d)},"post"===a.method||"put"===a.method?(this.xhr.setRequestHeader("Content-Type","application/json"),this.xhr.send(JSON.stringify(this.data.value))):this.xhr.send(),b.status.value=nx.AsyncStatus.LOADING},nx.Binding=function(a,b,c){this.source=a,this.target=b,this.conversion=c},nx.Binding.prototype.sync=function(){if("undefined"!=typeof this.lock){if(this.lock.locked)return void(this.lock.locked=!1);this.lock.locked=!0}var a=this.source.value;"undefined"!=typeof this.conversion&&(this.conversion instanceof nx.Mapping?a=this.conversion.map(a,this.target.value):"function"==typeof this.conversion&&(a=this.conversion(a))),this.target.value=a,this.target.onsync.trigger(a)},nx.Binding.prototype.pair=function(a){return this.lock=a.lock={locked:!1}},nx.Binding.prototype.unbind=function(){delete this.source.bindings[this.index]},nx.Cell=function(a){a=a||{},"undefined"!=typeof a.value&&(this._value=a.value),this._bindingIndex=0,this.bindings={},this.onvalue=new nx.Event,this.onsync=new nx.Event,"undefined"!=typeof a.action&&this.onvalue.add(a.action)},Object.defineProperty(nx.Cell.prototype,"value",{enumerable:!0,get:function(){return this._value},set:function(a){this._value=a,this.onvalue.trigger(a);for(var b in this.bindings)this.bindings[b].sync()}}),nx.Cell.prototype._createBinding=function(a,b){var c=new nx.Binding(this,a,b);return c.index=this._bindingIndex,this.bindings[this._bindingIndex++]=c,c},nx.Cell.prototype["->"]=function(a,b,c){var d=this._createBinding(a,b);return c&&d.sync(),d},nx.Cell.prototype["<-"]=function(a,b,c){var d,e=this;return Array.isArray(a)?(d=new Array(a.length),a.map(function(a,f){return d[f]=a.value,a["->"](e,function(a){return d[f]=a,b.apply(null,d)},c)})):a["->"](this,b,c)},nx.Cell.prototype["->>"]=function(a,b){return this["->"](a,b,!0)},nx.Cell.prototype["<<-"]=function(a,b){return this["<-"](a,b,!0)},nx.Cell.prototype["<->"]=function(a,b,c){b instanceof nx.Mapping&&(c=c||b.inverse());var d=this._createBinding(a,b),e=a._createBinding(this,c);return d.pair(e),d.sync(),[d,e]},nx.Cell.prototype.bind=function(a,b,c,d){this[b](a,c,d)},nx.Cell.prototype.set=function(a){this._value=a},nx.Collection=function(a){a=a||{},nx.Cell.call(this);var b=this;this.event=new nx.Cell,this.items=a.items||[],this.onsync.add(function(a){b.event.value=new nxt.Command("Content","reset",{items:a})}),this.length=new nx.Cell({value:this.items.length}),this.length["<-"](this,function(a){return a.length})},nx.Utils.mixin(nx.Collection.prototype,nx.Cell.prototype),nx.Collection.prototype.constructor=nx.Collection,Object.defineProperty(nx.Collection.prototype,"items",{enumerable:!0,get:function(){return this.value},set:function(a){this.value=a,this.event.value=new nxt.Command("Content","reset",{items:a})}}),nx.Collection.prototype.append=function(){var a=[].slice.call(arguments);this.value=this.value.concat(a),this.event.value=new nxt.Command("Content","append",{items:a})},nx.Collection.prototype.remove=function(){var a=[].slice,b=a.call(arguments),c=[];this.value=this.items.filter(function(a,d){var e=b.indexOf(a);return-1!==e?(c.push(d),b.splice(e,1),!1):!0}),this.event.value=new nxt.Command("Content","remove",{items:a.call(arguments),indexes:c})},nx.Collection.prototype.insertBefore=function(a,b){b=Array.isArray(b)?b:[b];var c=this.items.indexOf(a);[].splice.apply(this.items,[c,0].concat(b)),this.event.value=new nxt.Command("Content","insertBefore",{items:b,index:c})},nx.Collection.prototype.reset=function(a){this.items=a||[]},nx.Collection.prototype.swap=function(a,b){var c=this.items.indexOf(a),d=this.items.indexOf(b);this.items[c]=b,this.items[d]=a,this.event.value=new nxt.Command("Content","swap",{indexes:[c,d]})},nx.Event=function(){this.handlers={},this._nameIndex=0},nx.Event.prototype.trigger=function(a){for(var b in this.handlers)this.handlers[b].call(null,a)},nx.Event.prototype.add=function(a,b){return b=b||this._nameIndex++,this.handlers[b]=a,b},nx.Event.prototype.remove=function(a){delete this.handlers[a]},nx.Mapping=function(a){this.pattern=a},nx.Mapping.prototype.map=function(a,b){if("undefined"!=typeof this.pattern){for(var c in this.pattern)if("_"===c&&"undefined"!=typeof b)b[this.pattern[c]]=a;else{if("_"===this.pattern[c]&&"undefined"!=typeof a)return b=a[c];"undefined"!=typeof a&&"undefined"!=typeof b&&(b[this.pattern[c]]=a[c])}return b}return b=a},nx.Mapping.prototype.inverse=function(){var a={};for(var b in this.pattern)a[this.pattern[b]]=b;return new nx.Mapping(a)},nxt.CommandBinding=function(a,b,c){nx.Binding.call(this,a,b,c),this.index=a._bindingIndex,a.bindings[a._bindingIndex++]=this},nx.Utils.mixin(nxt.CommandBinding.prototype,nx.Binding.prototype),nxt.CommandBinding.prototype.sync=function(){nxt.CommandCellModel.enter(this.target),nx.Binding.prototype.sync.call(this),nxt.CommandCellModel.exit()},nxt.CommandCellModel={cellStack:[],enter:function(a){var b=[a];if(a.cleanup){for(;b.length>0;)for(var c=b.shift(),d=0;d<c.children.length;d++)c.children[d].unbind(),b.push(c.children[d]);a.children=[]}if(this.cellStack.length>0){var e=this.cellStack[this.cellStack.length-1];e.children.push(a)}this.cellStack.push(a)},exit:function(){this.cellStack.pop()}},nxt.CommandCell=function(a){a=a||{cleanup:!0},nx.Cell.call(this,a),this.cleanup=a.cleanup,this.children=[]},nx.Utils.mixin(nxt.CommandCell.prototype,nx.Cell.prototype),nxt.CommandCell.prototype.reverseBind=function(a,b){return this._binding=new nxt.CommandBinding(a,this,b),this._binding.sync(),this._binding},nxt.CommandCell.prototype.unbind=function(){"undefined"!=typeof this._binding&&this._binding.unbind()},nxt.Command=function(a,b,c){this.type=a,this.method=b,this.data=c},nxt.Command.prototype.run=function(){return this.renderer=nxt[this.type+"Renderer"],this.renderer[this.method].apply(this.renderer,[this.data].concat([].slice.apply(arguments)))},nxt.ContentRegion=function(a){this.domContext=a,this.cells=[]},nxt.ContentRegion.prototype.add=function(a){var b=(this.cells.length,this),c=new nx.Cell({value:{index:this.cells.length,domContext:{container:this.domContext.container,insertReference:this.domContext.insertReference},visible:!1},action:function(a){b.update(a)}});a.bind(c,"->>",new nx.Mapping({_:"command"})),this.cells.push(c)},nxt.ContentRegion.prototype.update=function(a){{var b="undefined"!=typeof a.renderer,c="undefined"==typeof a.command;a.visible}b&&(c?(a.domContext.content=a.renderer.unrender(a.domContext),a.visible=!1,delete a.renderer):a.renderer!==nxt[a.command.type+"Renderer"]&&(a.domContext.content=a.renderer.unrender(a.domContext))),c||(a.domContext.content=a.command.run(a.domContext),a.renderer=a.command.renderer,a.visible="function"==typeof a.renderer.visible?a.renderer.visible(a.domContext.content):nxt.NodeRenderer.visible(a.domContext.content));var d;d=a.visible?Array.isArray(a.domContext.content)?a.domContext.content[0]:a.domContext.content:a.domContext.insertReference;for(var e=a.index-1;e>=0&&(this.cells[e].value.domContext.insertReference=d,!this.cells[e].value.visible);e--);},nxt.ContentRenderer={render:function(a,b){var c=[],d=[],e=this;return a.items.forEach(function(a){if(void 0!==a)if(a instanceof nxt.Command){var f=a.run(b);if(d.push(f),c.length>0){{var g={container:b.container};nxt[a.type+"Renderer"]}nxt.NodeRenderer.visible(f)&&(g.insertReference=f),e.createRegion(g,c),c=[]}}else c.push(a)}),c.length>0&&this.createRegion({container:b.container,insertReference:b.insertReference},c),d},createRegion:function(a,b){for(var c=new nxt.ContentRegion(a),d=0;d<b.length;d++)c.add(b[d]);return c},append:function(a,b){return(b.content||[]).concat(this.render(a,{container:b.container,insertReference:b.insertReference}))},insertBefore:function(a,b){var c=b.content[a.index],d=a.items.map(function(a){return a.run({container:b.container,insertReference:c})});return[].splice.apply(b.content,[a.index,0].concat(d)),b.content},remove:function(a,b){return a.indexes.sort(function(a,b){return a-b}).forEach(function(a,c){b.container.removeChild(b.content[a-c]),b.content.splice(a-c,1)}),b.content},reset:function(a,b){if("undefined"!=typeof b.content){for(var c=0;c<b.content.length;c++)b.container.removeChild(b.content[c]);delete b.content}return this.render(a,b)},swap:function(a,b){a.indexes.sort(function(a,b){return a-b});var c=a.indexes[0],d=a.indexes[1],e=b.content[c],f=b.content[d],g=null;return a.indexes[1]<b.content.length-1&&(g=b.content[d+1]),b.container.insertBefore(f,e),b.container.insertBefore(e,g),b.content[c]=f,b.content[d]=e,b.content},get:function(a,b){return a.next(b.content),b.content},visible:function(a){return a.some(nxt.NodeRenderer.visible)}},nxt.Attr=function(a,b){var c="string"==typeof a?{name:a,value:"undefined"==typeof b?"":b}:{items:a};return new nxt.Command("Attr","render",c)},nxt.Class=function(a){return new nxt.Command("Class","render",{name:a})},nxt.Text=function(a){return"undefined"==typeof a?void 0:new nxt.Command("Node","render",{node:document.createTextNode(a),text:a})},nxt.Event=function(a,b){return new nxt.Command("Event","add",{name:a,handler:b})},nxt.Element=function(){var a=[].slice.call(arguments);a=a.reduce(function(a,b){return a.concat(b)},[]);var b=a[0],c=document.createElement(b);if(a.length>1){var d=a.slice(1);nxt.ContentRenderer.render({items:d},{container:c})}return new nxt.Command("Node","render",{node:c})},nxt.Binding=function(a,b){var c=new nxt.CommandCell;return c.reverseBind(a,b),c},nxt.ItemEvent=function(a,b){return{name:a,handlers:b}},nxt.Collection=function(){var a=arguments[0],b=arguments[1],c=[].slice.call(arguments,2),d=new nxt.CommandCell({cleanup:!1});a.event.value=new nxt.Command("Content","reset",{items:a.items}),d.reverseBind(a.event,function(a){return"undefined"!=typeof a&&(a.data.items=a.data.items.map(b)),a});var e;return c.length>0?(e=c.map(function(b){return nxt.Event(b.name,function(c){var d,e,f=c.target;a.event.value=new nxt.Command("Content","get",{items:[],next:function(g){g.some(function(a,b){var c=a.isEqualNode(f)||a.contains(f);return c&&(d=b,e=a),c});for(var h=Object.keys(b.handlers),i=function(e){f.matches(e)&&b.handlers[e].call(null,c,a.items[d])};!e.isEqualNode(f);)h.forEach(i),f=f.parentNode;h.forEach(i)}})})}),[d].concat(e)):d},nxt.ValueBinding=function(a,b,c){var d={locked:!1},e=nxt.Event("input",function(){d.locked=!0,a.value=c?c(this.value):this.value}),f=new nxt.CommandCell,g=f.reverseBind(a,function(a){return d.locked=!1,nxt.Attr("value",b?b(a):a)});return g.lock=d,[e,f]},nxt.Style=function(a){return new nxt.Command("Style","render",a)},nxt.AttrRenderer={render:function(a,b){var c={};if("undefined"!=typeof a.items){for(var d in a.items)"value"===d?b.container.value=a.items[d]:b.container.setAttribute(d,a.items[d]);c=a.items}else"value"===a.name?b.container.value=a.value:b.container.setAttribute(a.name,a.value),c[a.name]=a.value;return c},unrender:function(a){for(var b in a.content)a.container.removeAttribute(b)}},nxt.ClassRenderer={render:function(a,b){return b.container.classList.add(a.name),a.name},unrender:function(a){a.container.classList.remove(a.content)}},nxt.EventRenderer={add:function(a,b){return b.container.addEventListener(a.name,a.handler),a},unrender:function(a){a.container.removeEventListener(a.content.name,a.content.handler)}},nxt.NodeRenderer={render:function(a,b){return"undefined"!=typeof b.content?b.container.replaceChild(a.node,b.content):"undefined"!=typeof b.insertReference?b.container.insertBefore(a.node,b.insertReference):b.container.appendChild(a.node),a.node},visible:function(a){return"undefined"!=typeof a&&(a.nodeType===Node.ELEMENT_NODE||a.nodeType===Node.TEXT_NODE)},unrender:function(a){a.container.removeChild(a.content)}},nxt.StyleRenderer={render:function(a,b){for(var c in a)b.container.style.setProperty(c,a[c]);return a},unrender:function(a){for(var b in a.content)a.container.style.removeProperty(b)}},nx.RestCollection=function(a){nx.Collection.call(this,a),nx.AjaxModel.call(this,a),this.options=a;var b=this;this.bind(this.data,"<->",function(a){return a.map(function(a){return a.data.value})},function(a){return a.map(function(a){return new b.options.item(a)})})},nx.Utils.mixin(nx.RestCollection.prototype,nx.Collection.prototype),nx.Utils.mixin(nx.RestCollection.prototype,nx.AjaxModel.prototype),nx.RestCollection.prototype.constructor=nx.RestCollection,nx.RestCollection.prototype.request=function(a){var b=this;nx.AjaxModel.prototype.request.call(this,{url:this.options.url,method:a.method,success:function(){"function"==typeof a.success&&a.success(b.items)}})},nx.RestCollection.prototype.create=function(a,b){nx.RestDocument.prototype.request.call(a,{url:this.options.url,method:"post",success:b})},nx.RestCollection.prototype.retrieve=function(a){this.request({method:"get",success:a})},nx.RestCollection.prototype.remove=function(a,b){var c=this;a.remove(function(){nx.Collection.prototype.remove.call(c,a),"function"==typeof b&&b()})},nx.RestDocument=function(a){nx.AjaxModel.call(this,a),this.options=a},nx.Utils.mixin(nx.RestDocument.prototype,nx.AjaxModel.prototype),nx.RestDocument.prototype.constructor=nx.RestDocument,nx.RestDocument.prototype.request=function(a){nx.AjaxModel.prototype.request.call(this,{url:a.url||this.options.url,method:a.method,success:a.success})},nx.RestDocument.prototype.retrieve=function(a){this.request({method:"get",success:a})},nx.RestDocument.prototype.save=function(a){this.request({method:"put",success:a})},nx.RestDocument.prototype.remove=function(a){this.request({method:"delete",success:a})}}();